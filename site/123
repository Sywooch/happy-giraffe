SELECT SQL_NO_CACHE
    u.id AS uId, # ID собеседника
    u.first_name, # Имя собеседника
    u.last_name, # Фамилия собеседника
    u.gender, # Пол собеседника
    u.online, # Онлайн-статус собеседника
    t.id AS tId, # ID Диалога
    tu2.hidden, # Видимость диалога
    p.fs_name, # Аватар
    UNIX_TIMESTAMP(t.updated) AS updated, # Дата последнего обновления диалога
    COUNT(mu.message_id) AS unreadCount, # Количество непрочитанных сообщений
    friends.created IS NOT NULL AS isFriend # Является ли другом
# Таблица ID всех пользователей в контактах
FROM (
    # Пользователей, находящиеся в друзьях вне зависимости от наличия или отсутствия переписки с ними
    SELECT user1_id AS uId
    FROM friends
    WHERE user2_id = 12936
    UNION
    SELECT user2_id AS uId
    FROM friends
    WHERE user1_id = 12936
    UNION
    # Пользователи, с которыми когда-либо была переписка
    SELECT tu2.user_id AS uId
    FROM messaging__threads_users tu
    INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
    WHERE tu.user_id = 12936
) uIds
# Связывание с таблицей пользователей для получения данных о собеседнике
INNER JOIN users u ON u.id = uIds.uId
# Связывание с таблицей друзей для установления, является ли собеседник другом
LEFT OUTER JOIN friends ON (u.id = friends.user1_id AND friends.user2_id = 12936) OR (u.id = friends.user2_id AND friends.user1_id = 12936)
# Связывание с таблицей участников диалога для получения ID и видимости диалога
LEFT OUTER JOIN messaging__threads_users tu ON tu.user_id = u.id
LEFT OUTER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id = 12936
# Связывание с таблицей диалогов для получения данных о диалоге
LEFT OUTER JOIN messaging__threads t ON t.id = tu2.thread_id
# Связывание с таблицами сообщений и получателей сообщения для получения количества непрочитанных сообщений
LEFT OUTER JOIN messaging__messages m ON m.thread_id = t.id AND m.author_id != 12936
LEFT OUTER JOIN messaging__messages_users mu ON m.id = mu.message_id AND mu.read = 0 AND mu.user_id = 12936
# Связывание с таблицей фотографий для получения аватара
LEFT OUTER JOIN album__photos p ON u.avatar_id = p.id
# Условие для корректной работы связывание с таблицей участников диалога
WHERE tu.user_id IS NULL OR (tu.user_id IS NOT NULL AND tu2.user_id IS NOT NULL)
GROUP BY u.id;

SELECT SQL_NO_CACHE
    u.id AS uId, # ID собеседника
    u.first_name, # Имя собеседника
    u.last_name, # Фамилия собеседника
    u.gender, # Пол собеседника
    u.online, # Онлайн-статус собеседника
    t.id AS tId, # ID Диалога
    tu2.hidden, # Видимость диалога
    p.fs_name, # Аватар
    UNIX_TIMESTAMP(t.updated) AS updated, # Дата последнего обновления диалога
    COUNT(mu.message_id) AS unreadCount, # Количество непрочитанных сообщений
    friends.created IS NOT NULL AS isFriend # Является ли другом
# Таблица ID всех пользователей в контактах
FROM (
    # Пользователей, находящиеся в друзьях вне зависимости от наличия или отсутствия переписки с ними
    SELECT user1_id AS uId
    FROM friends
    WHERE user2_id = 12936
    UNION
    SELECT user2_id AS uId
    FROM friends
    WHERE user1_id = 12936
    UNION
    # Пользователи, с которыми когда-либо была переписка
    SELECT tu2.user_id AS uId
    FROM messaging__threads_users tu
    INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
    WHERE tu.user_id = 12936
) uIds
# Связывание с таблицей пользователей для получения данных о собеседнике
INNER JOIN users u ON u.id = uIds.uId
# Связывание с таблицей друзей для установления, является ли собеседник другом
LEFT OUTER JOIN friends ON (u.id = friends.user1_id AND friends.user2_id = 12936) OR (u.id = friends.user2_id AND friends.user1_id = 12936)
# Связывание с таблицей участников диалога для получения ID и видимости диалога
LEFT OUTER JOIN messaging__threads_users tu ON tu.user_id = u.id
LEFT OUTER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id = 12936
# Связывание с таблицей диалогов для получения данных о диалоге
LEFT OUTER JOIN messaging__threads t ON t.id = tu2.thread_id
# Связывание с таблицами сообщений и получателей сообщения для получения количества непрочитанных сообщений
LEFT OUTER JOIN messaging__messages m ON m.thread_id = t.id AND m.author_id != 12936
LEFT OUTER JOIN messaging__messages_users mu ON m.id = mu.message_id AND mu.read = 0 AND mu.user_id = 12936
# Связывание с таблицей фотографий для получения аватара
LEFT OUTER JOIN album__photos p ON u.avatar_id = p.id
# Условие для корректной работы связывание с таблицей участников диалога
WHERE tu.user_id IS NULL OR (tu.user_id IS NOT NULL AND tu2.user_id IS NOT NULL) AND uId NOT IN (SELECT blocked_user_id FROM blacklist WHERE user_id = 12936)
GROUP BY u.id;

SELECT SQL_NO_CACHE
    u.id AS uId, # ID собеседника
    u.first_name, # Имя собеседника
    u.last_name, # Фамилия собеседника
    u.gender, # Пол собеседника
    u.online, # Онлайн-статус собеседника
    t.id AS tId, # ID Диалога
    tu2.hidden, # Видимость диалога
    p.fs_name, # Аватар
    UNIX_TIMESTAMP(t.updated) AS updated, # Дата последнего обновления диалога
    COUNT(mu.message_id) AS unreadCount, # Количество непрочитанных сообщений
    friends.created IS NOT NULL AS isFriend # Является ли другом
# Таблица ID всех пользователей в контактах
FROM (
    # Пользователей, находящиеся в друзьях вне зависимости от наличия или отсутствия переписки с ними
    SELECT user1_id AS uId
    FROM friends
    WHERE user2_id = 12936
    UNION
    SELECT user2_id AS uId
    FROM friends
    WHERE user1_id = 12936
    UNION
    # Пользователи, с которыми когда-либо была переписка
    SELECT tu2.user_id AS uId
    FROM messaging__threads_users tu
    INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
    WHERE tu.user_id = 12936
) uIds
# Связывание с таблицей пользователей для получения данных о собеседнике
INNER JOIN users u ON u.id = uIds.uId
# Связывание с таблицей друзей для установления, является ли собеседник другом
LEFT OUTER JOIN friends ON (u.id = friends.user1_id AND friends.user2_id = 12936) OR (u.id = friends.user2_id AND friends.user1_id = 12936)
# Связывание с таблицей участников диалога для получения ID и видимости диалога
LEFT OUTER JOIN messaging__threads_users tu ON tu.user_id = u.id
LEFT OUTER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id = 12936
# Связывание с таблицей диалогов для получения данных о диалоге
LEFT OUTER JOIN messaging__threads t ON t.id = tu2.thread_id
# Связывание с таблицами сообщений и получателей сообщения для получения количества непрочитанных сообщений
LEFT OUTER JOIN messaging__messages m ON m.thread_id = t.id AND m.author_id != 12936
LEFT OUTER JOIN messaging__messages_users mu ON m.id = mu.message_id AND mu.read = 0 AND mu.user_id = 12936
# Связывание с таблицей фотографий для получения аватара
LEFT OUTER JOIN album__photos p ON u.avatar_id = p.id
LEFT OUTER JOIN blacklist b ON b.user_id = 12936 AND b.blocked_user_id = uId
# Условие для корректной работы связывание с таблицей участников диалога
WHERE tu.user_id IS NULL OR (tu.user_id IS NOT NULL AND tu2.user_id IS NOT NULL) AND b.user_id IS NULL
GROUP BY u.id;
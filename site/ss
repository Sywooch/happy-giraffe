SELECT SQL_NO_CACHE tu.hidden, tu.thread_id, tu2.user_id AS interlocutor_id, u.first_name, u.last_name, u.online, (SELECT COUNT(*) FROM messaging__messages m INNER JOIN messaging__messages_users mu ON m.id = mu.message_id WHERE m.thread_id = tu.thread_id AND mu.user_id = 12936 AND mu.read = 0) AS unreadMessages
FROM messaging__threads_users tu
INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
INNER JOIN users u ON u.id = tu2.user_id
WHERE tu.user_id = 12936;

SELECT SQL_NO_CACHE tu.hidden, tu.thread_id, tu2.user_id AS interlocutor_id, u.first_name, u.last_name, u.online, COUNT(mu.message_id) AS unreadCount
FROM messaging__threads_users tu
INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
INNER JOIN users u ON u.id = tu2.user_id
LEFT OUTER JOIN messaging__messages m ON m.thread_id = tu.thread_id
LEFT OUTER JOIN messaging__messages_users mu ON m.id = mu.message_id AND mu.read = 0 AND mu.user_id = 12936
WHERE tu.user_id = 12936
GROUP BY tu.thread_id;

SELECT
    tu.hidden AS threadHiddenStatus,
    tu.thread_id AS threadId,
    tu2.user_id AS interlocutorId,
    u.first_name AS interlocutorFirstName,
    u.last_name AS interlocutorLastName,
    u.online AS interlocutorOnlineStatus,
    COUNT(mu.message_id) AS threadUnreadCount
FROM messaging__threads_users tu
INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
INNER JOIN users u ON u.id = tu2.user_id
LEFT OUTER JOIN messaging__messages m ON m.thread_id = tu.thread_id
LEFT OUTER JOIN messaging__messages_users mu ON m.id = mu.message_id AND mu.read = 0 AND mu.user_id = 12936
WHERE tu.user_id = 12936
GROUP BY tu.thread_id

SELECT SQL_NO_CACHE
    tu.hidden AS threadHiddenStatus,
    tu.thread_id AS threadId,
    tu2.user_id AS interlocutorId,
    u.first_name AS interlocutorFirstName,
    u.last_name AS interlocutorLastName,
    u.online AS interlocutorOnlineStatus,
    t.updated AS threadUpdated,
    COUNT(mu.message_id) AS threadUnreadCount
FROM messaging__threads_users tu
INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
INNER JOIN users u ON u.id = tu2.user_id
INNER JOIN messaging__threads t ON t.id = tu.thread_id
LEFT OUTER JOIN messaging__messages m ON m.thread_id = tu.thread_id
LEFT OUTER JOIN messaging__messages_users mu ON m.id = mu.message_id AND mu.read = 0 AND mu.user_id = 12936
WHERE tu.user_id = 12936
GROUP BY tu.thread_id;

SELECT SQL_NO_CACHE u.id, u.first_name, u.last_name, u.online
FROM users u
WHERE u.id IN (
    SELECT u2.id
    FROM users u2
    JOIN friends ON (u2.id = friends.user1_id AND friends.user2_id = 12936) OR (u2.id = friends.user2_id AND friends.user1_id = 12936)
);

SELECT SQL_NO_CACHE u.id, u.first_name, u.last_name, u.online
FROM users u
WHERE u.id IN (
    SELECT tu2.user_id
    FROM messaging__threads_users tu
    INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
    WHERE tu.user_id = 12936
);


SELECT u.id, u.first_name, u.last_name, u.online
FROM users u
WHERE u.id IN (
    SELECT u2.id
    FROM users u2
    JOIN friends ON (u2.id = friends.user1_id AND friends.user2_id = 10) OR (u2.id = friends.user2_id AND friends.user1_id = 10)
) OR u.id IN (
    SELECT tu2.user_id
    FROM messaging__threads_users tu
    INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 10
    WHERE tu.user_id = 10
);



SELECT user1_id
FROM friends
WHERE user2_id =12936
UNION
SELECT user2_id
FROM friends
WHERE user1_id =12936
UNION
SELECT tu2.user_id
FROM messaging__threads_users tu
INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
WHERE tu.user_id = 12936

SELECT u.id, u.first_name, u.last_name, u.online
FROM users u
WHERE u.id IN (
    SELECT user1_id
    FROM friends
    WHERE user2_id = 12936
    UNION
    SELECT user2_id
    FROM friends
    WHERE user1_id = 12936
    UNION
    SELECT tu2.user_id
    FROM messaging__threads_users tu
    INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
    WHERE tu.user_id = 12936
);

SELECT SQL_NO_CACHE
    u.id,
    u.first_name,
    u.last_name,
    u.online,
    friends.created IS NOT NULL AS isFriend,
    t.id,
    t.updated,
    tu2.hidden,
    COUNT(m.id) AS unreadCount
FROM (
    SELECT user1_id AS uId
    FROM friends
    WHERE user2_id = 12936
    UNION
    SELECT user2_id AS uId
    FROM friends
    WHERE user1_id = 12936
    UNION
    SELECT tu2.user_id AS uId
    FROM messaging__threads_users tu
    INNER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id != 12936
    WHERE tu.user_id = 12936
) uIds
INNER JOIN users u ON u.id = uIds.uId
LEFT OUTER JOIN friends ON (u.id = friends.user1_id AND friends.user2_id = 12936) OR (u.id = friends.user2_id AND friends.user1_id = 12936)
LEFT OUTER JOIN messaging__threads_users tu ON tu.user_id = u.id
LEFT OUTER JOIN messaging__threads_users tu2 ON tu.thread_id = tu2.thread_id AND tu2.user_id = 12936
LEFT OUTER JOIN messaging__threads t ON t.id = tu2.thread_id
LEFT OUTER JOIN messaging__messages m ON m.thread_id = t.id
LEFT OUTER JOIN messaging__messages_users mu ON m.id = mu.message_id AND mu.read = 0 AND mu.user_id = 12936
WHERE tu.user_id IS NULL OR (tu.user_id IS NOT NULL AND tu2.user_id IS NOT NULL)
GROUP BY t.id;